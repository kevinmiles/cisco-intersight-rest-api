# Introduction to the Cisco Intersight REST API with Python

This Introduction to the Cisco Intersight REST API with Python Learning Lab will guide you through the use of Cisco Intersight REST APIs with Python to perform Queries, Updates and Configuration with Cisco Intersight.

## Objectives

After completing this lab you will know:

- How to a Use Python to interact with Cisco Intersight REST APIs
- How to Remove Claimed Devices from Intersight

## Prerequisites
Prior to starting this learning lab, it would be helpful to have an understanding of Cisco Intersight functionality.

An understanding of REST, JSON and a bit of Python would also be helpful.

## Cisco Intersight REST API Documentation
Documentation for Cisco Intersight REST API is available at  [intersight.com](https://intersight.com/apidocs/introduction/overview/).

### Learning Lab Infrastructure Requirements
All the exercises in the Introduction to the Cisco Intersight REST API with Postman Learning Lab can be completed using the [Cisco Intersight Sandbox](https://devnetsandbox.cisco.com/RM/Diagram/Index/a63216d2-e891-4856-9f27-309ca61ec862?diagramType=Topology).

# Step 1: Get the Python Code

### Git the Python Code from Github
If you have recently completed the **Cisco Intersight REST API with Postman** Learning Lab and are using the same DevNet Cisco Intersight Sandbox, then you already have the Python Intersight REST API Code in the `C:\Users\administrator\Desktop\intersight-rest-api` directory.

The Python Intersight REST API files are named:

  - `intersight_auth.py`
  - `intersight_ops.py`

1. Launch **Git Bash** to clone the Github repository for this Learning Lab's code.

  - ***Double-Click*** the **Git Bash** shortcut on the desktop ![](assets/images/image-01.jpg)
  - ***Enter*** on the command line `cd Desktop` to change directory to the Administrator's Desktop
  - ***Enter*** on the command line the `git` command below to download the Intersight REST API Python Code.

    `git clone https://github.com/movinalot/intersight-rest-api`

  You have created a directory named `intersight-rest-api` and downloaded into it the Intersight REST API Python source code along with the Postman Collection for the Cisco Intersight REST API with Postman Learning Lab. You only need the Python source code for this Learning Lab. If you follow-up this lab with the Cisco Intersight REST API with Postman Learning Lab you do not have to re-clone the `intersight-rest-api` repository.

  ![](assets/images/image-02.jpg)<br/><br/>

### Open and Update the Python Intersight REST API Code

1. Open and Update the Intersight REST API code

  - ***Double-Click*** the `intersight-rest-api folder ` on the desktop ![](assets/images/image-03.jpg)
  - ***Right-Click*** the python file `intersight_ops.py`
  - ***Hover*** over the **second** menu option "Edit with IDLE"
  - ***Click*** the menu option "Edit with IDLE 3.7 (64-bit)"

  This will open the python file `intersight_auth.py` in the Python 3.7 IDLE editor.

    ![](assets/images/image-04.jpg)<br/><br/>

2. Update the python code with your Intersight REST API Keys

  - ***Update*** the variable `secret_key_filename` with the location of the `SecretKey.txt` file that was downloaded from the Intersight interface. If you followed the Intersight REST API Learning Lab where you created the Intersight REST API Keys then the path to the `SecretKey.txt` file should match what is in the downloaded source code.

    `C:\\Users\\administrator\\Downloads\\SecretKey.txt`

  - ***Update*** the variable `api_key_id` with the API Key ID from the Intersight interface.<br/><br/>

  ![](assets/images/image-05.jpg)<br/><br/>
  ![](assets/images/image-06.jpg)<br/><br/>
  ![](assets/images/image-07.jpg)<br/><br/>
  ![](assets/images/image-08.jpg)<br/><br/>

### Code Explanation

#### Imports / Authentication / REST API URL
The code imports the `json` and `requests` python modules.
  - The `json` module functionality allows you to manipulate JSON encoded data.
  - The `requests` module functionality allows you to interact with REST APIs by providing functions for `HTTP` methods. The `HTTP` methods supported by the Intersight REST API are:

    - **GET** - to Query Intersight objects
    - **DELETE** - to Delete Intersight objects
    - **PATCH** - to Update Intersight objects
    - **POST** - to Create/Update Intersight objects

  - The `IntersightAuth` Class is imported from the `intersight_auth.py` python module

  - The `IntersightAuth` Class is instantiated in as the `AUTH` object.

  - The constant `BURL` is the Url for the Intersight V1 REST API.

  Intersight uses an authentication mechanism that hashes and signs the Intersight REST API request with your API Keys. Prior to every Intersight REST API request the `AUTH` object is called and the request is hashed and signed.

#### Intersight REST API OPERATIONS

```python
OPERATIONS = [
    {
        "resource_path":"compute/PhysicalSummaries",
        "request_method":"GET"
    },
    {
        "resource_path":"ntp/Policies",
        "request_method":"GET"
    },
    {
        "resource_path":"ntp/Policies",
        "request_method":"POST",
        "request_body":{
            "Enabled":True,
            "Name":"ntp-policy",
            "Description":"NTP Policy for ntp.org",
            "NtpServers":[
                "pool.ntp.org"
                ],
            "Tags":[]
        }
    },
    {
        "resource_path":"ntp/Policies",
        "request_method":"POST",
        "request_body":{
            "Enabled":True,
            "Name":"ntp-policy-west",
            "Description":"NTP Policy for ntp.org West Coast",
            "NtpServers":[
                "0.pool.ntp.org",
                "1.pool.ntp.org"
                ],
            "Tags":[]
        }
    },
    {
        "resource_path":"ntp/Policies",
        "request_method":"POST",
        "request_body":{
            "Enabled":True,
            "Name":"ntp-policy-east",
            "Description":"NTP Policy for ntp.org East Coast",
            "NtpServers":[
                "2.pool.ntp.org",
                "3.pool.ntp.org"
                ],
            "Tags":[]
        }
    },
    {
        "resource_name":"ntp-policy",
        "resource_path":"ntp/Policies",
        "request_method":"PATCH",
        "request_body":{
            "NtpServers":[
                "pool.ntp.org",
                "10.10.10.30"
                ]
            }
    },
    {
        "resource_name":"ntp-policy-east",
        "resource_path":"ntp/Policies",
        "request_method":"DELETE"
    }
]
```

`OPERATIONS` is a python list of python dictionaries. Each dictionary represents the input to an Intersight REST API call.

  - `resource_path` - what object resource does this request act upon
  - `request_method` - what type of REST API request is being made on the resource
  - `request_body` - the attributes needed to create or update the resource (not required for a GET or DELETE)

  - `resource_name` - name of the resource to be updated or deleted

  The `OPERATIONS` are:

    - **GET** `compute/PhysicalSummaries` - query for all the compute resources associated with your Intersight account
    - **GET** `ntp/Policies` - query for all the NTP Policies associated with your Intersight account
    - **POST** `ntp/Policies` - create an NTP Policy named `ntp-policy`
    - **POST** `ntp/Policies` - create an NTP Policy named `ntp-policy-west`
    - **POST** `ntp/Policies` - create an NTP Policy named `ntp-policy-east`
    - **PATCH** `ntp/Policies` update NTP Policy for NTP Policy named `ntp-policy`
    - **DELETE** `ntp/Policies` for NTP Policy named `ntp-policy-east`

  Processing the `OPERATIONS`

  ```python
  for operation in OPERATIONS:

      response = None
      print(operation['request_method'])

      # GET
      if operation['request_method'] == "GET":
          response = requests.get(
              BURL + operation['resource_path'],
              auth=AUTH
              )

      # POST
      if operation['request_method'] == "POST":
          response = requests.post(
              BURL + operation['resource_path'],
              data=json.dumps(operation['request_body']),
              auth=AUTH
              )

      # PATCH
      if operation['request_method'] == "PATCH":

          # GET the Moid of the MO to PATCH
          response = requests.get(
              (
                  BURL + operation['resource_path'] +
                  "?$filter=Name eq '" + operation['resource_name'] + "'"
                  ),
              auth=AUTH
              )

          # Extract the Moid from the Results
          json_result = json.loads(response.text)
          moid = json_result["Results"][0]["Moid"]

          response = requests.patch(
              BURL + operation['resource_path'] + "/" + moid,
              data=json.dumps(operation['request_body']),
              auth=AUTH
              )

      # DELETE
      if operation['request_method'] == "DELETE":

          # GET the Moid of the MO to DELETE
          response = requests.get(
              (
                  BURL + operation['resource_path'] +
                  "?$filter=Name eq '" + operation['resource_name'] + "'"
                  ),
              auth=AUTH
              )

          # Extract the Moid from the Results
          json_result = json.loads(response.text)
          moid = json_result["Results"][0]["Moid"]

          response = requests.delete(
              BURL + operation['resource_path'] + "/" + moid,
              auth=AUTH
              )

      print(response)
      print(response.text)
  ```

  For each dictionary in the `OPERATIONS` list set the variable `operation` to the current dictionary. Call the appropriate `requests` method based on the value of `request_method` in the `operation` dictionary.

  If the `request_method` is a **GET**

    - Use the `requests.get()` method
    - Set the REST API resource by appending the `resource_path` to the end of the Intersight REST API Base URL.
    - Supply the `AUTH` object as the authentication mechanism that the `requests.get()` method should use.

  ```python
  response = requests.get(
      BURL + operation['resource_path'],
      auth=AUTH
      )
  ```

  If the `request_method` is a **POST**

    - Use the `requests.post()` method
    - Set the REST API resource by appending the `resource_path` to the end of the Intersight REST API Base URL.
    - Set the `requests.post()` parameter `data` to the JSON encoded value of the `request_body`
    - Supply the `AUTH` object as the authentication mechanism that the `requests.post()` method should use.

  ```python
  response = requests.post(
      BURL + operation['resource_path'],
      data=json.dumps(operation['request_body']),
      auth=AUTH
      )
  ```

  If the `request_method` is a **PATCH**

    - Query Intersight for the `resource_name` using a **GET**
    - Encode the **GET** `response.text` as JSON
    - Extract from the **GET** request response the `Moid` (Intersight Managed Object ID) of the found object

    - Use the `requests.patch()` method
    - Set the REST API resource by appending the `resource_path` to the end of the Intersight REST API Base URL. Then appending to that the `Moid` of the existing object.
    - Set the `requests.patch()` parameter `data` to the JSON encoded value of the `request_body`
    - Supply the `AUTH` object as the authentication mechanism that the `requests.patch()` method should use.

  ```python
  response = requests.patch(
      BURL + operation['resource_path'] + "/" + moid,
      data=json.dumps(operation['request_body']),
      auth=AUTH
      )
  ```

  If the `request_method` is a **DELETE**

    - Query Intersight for the `resource_name` using a **GET**
    - Encode the **GET** `response.text` as JSON
    - Extract from the **GET** request response the `Moid` (Intersight Managed Object ID) of the found object

    - Use the `requests.delete()` method
    - Set the REST API resource by appending the `resource_path` to the end of the Intersight REST API Base URL. Then appending to that the `Moid` of the existing object.
    - Supply the `AUTH` object as the authentication mechanism that the `requests.delete()` method should use.

  ```python
  response = requests.delete(
      BURL + operation['resource_path'] + "/" + moid,
      auth=AUTH
      )
  ```

  At the end of the for each loop print:
    - `response` - provides the HTTP status code of the request
    - `response.txt` - provides the JSON encoded results

Next Step: Running the Python Code to Interact with Cisco Intersight.
